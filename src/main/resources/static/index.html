<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Cloud Storage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
<h2>üîê Secure Cloud Storage</h2>

<div id="authSection">
    <button class="btn btn-primary" onclick="login()">Login with AWS Cognito</button>
</div>

<div id="appSection" style="display:none;">
    <div class="mb-3">
        <h4>Upload File</h4>
        <input type="file" id="fileInput" class="form-control">
        <button class="btn btn-success mt-2" onclick="uploadFile()">Upload Encrypted</button>
    </div>
    <hr>
    <h4>My Files</h4>
    <ul id="fileList" class="list-group"></ul>
</div>

<script>
    let token = null;

    // 1. CONFIGURE THIS
    const COGNITO_DOMAIN = "https://ap-south-1nailx8tif.auth.ap-south-1.amazoncognito.com"; // Found in Cognito -> App Integration -> Domain name
    const CLIENT_ID = "ak4at5qbloie37to088a6h90s"; // From Phase 1
    const REDIRECT_URI = "http://localhost:8080/index.html";

    // Check if we just came back from login
    window.onload = function() {
        const hash = window.location.hash;
        if (hash.includes("id_token")) {
            token = hash.split("id_token=")[1].split("&")[0];
            document.getElementById("authSection").style.display = "none";
            document.getElementById("appSection").style.display = "block";
            loadFiles();
        }
    };

    function login() {
        window.location.href = `${COGNITO_DOMAIN}/login?client_id=${CLIENT_ID}&response_type=token&scope=email+openid&redirect_uri=${REDIRECT_URI}`;
    }

    // Replace your old uploadFile function with this one
    async function uploadFile() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) {
            alert("Please select a file first!");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
            const response = await fetch("/api/files/upload", {
                method: "POST",
                headers: { "Authorization": "Bearer " + token },
                body: formData
            });

            if (response.ok) {
                alert("‚úÖ Success! File Encrypted & Uploaded.");
                loadFiles(); // Refresh the list
            } else {
                // If the server failed, show the error code
                alert("‚ùå Upload Failed! Server Error: " + response.status);
            }
        } catch (error) {
            alert("‚ùå Network Error: " + error.message);
        }
    }

    async function loadFiles() {
        const res = await fetch("/api/files", {
            headers: { "Authorization": "Bearer " + token }
        });
        const files = await res.json();
        const list = document.getElementById("fileList");
        list.innerHTML = "";
        files.forEach(f => {
            // OLD: onclick="download('${f.fileId}')"
// NEW: onclick="download('${f.fileId}', '${f.filename}')"

            list.innerHTML += `<li class="list-group-item d-flex justify-content-between">
                ${f.filename}
                <button class="btn btn-sm btn-outline-primary" onclick="download('${f.fileId}', '${f.filename}')">Download</button>
            </li>`;
        });
    }

    async function download(id, filename) {
        try {
            const res = await fetch(`/api/files/${id}/download`, {
                headers: { "Authorization": "Bearer " + token }
            });

            if (!res.ok) throw new Error("Download failed");

            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;

            // HERE IS THE FIX: Use the variable 'filename' instead of "decrypted_file"
            a.download = filename;

            document.body.appendChild(a);
            a.click();
            a.remove();
        } catch (e) {
            alert("Error downloading file: " + e.message);
        }
    }
</script>
</body>
</html>